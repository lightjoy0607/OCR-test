<!DOCTYPE html>
<html lang="zh">
<head>



    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCR æ ¡æ­£å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background-color: #f4f4f4;
        }


        /* âœ… ç¢ºä¿ã€Œä¸‰æ¬„ä½ˆå±€ã€èƒ½å¤ æ­£ç¢ºé¡¯ç¤º */
        .container {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            width: 95%;
            max-width: 1400px;
        }

        /* âœ… å·¦ã€ä¸­ã€å³ä¸‰æ¬„ */
        .left-column, .middle-column, .right-column {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* âœ… è®“æ¯”å°çµæœ & æ ¡æ­£é‚è¼¯æ›´æ¸…æ¥š */
        .diff-container, #correctionLog {
            background: #f9f9f9;
            border: 1px solid #ccc;
            padding: 10px;
            font-size: 16px;
            line-height: 1.6;
            white-space: pre-wrap;
            overflow-wrap: break-word;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
        }

        /* âœ… æ‰¹é‡ä¸Šå‚³ç›¸é—œ*/
        .batch-upload {
            width: 95%;
            max-width: 800px;
            background: #f9f9f9;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            margin-top: 10px;
            margin-bottom: 20px;
}


        textarea {
            width: 300px;
            height: 200px;
            padding: 10px;
            font-size: 16px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            margin-top: 20px;
            cursor: pointer;
        }
        /* è®€å–å‹•ç•« */
        .loading {
            display: none;
            font-size: 18px;
            margin-top: 10px;
        }

        
        /* âœ… è£½ä½œè€…åç¨±çš„æ¨£å¼ */
    .creator {
    font-size: 14px;
    color: #555;
    margin-top: -5px;
    font-style: italic;
}

/* âœ… ç‰ˆæœ¬è™Ÿé¡¯ç¤ºåœ¨å³ä¸‹è§’ */
#versionNumber {
    position: fixed;
    right: 10px;
    bottom: 10px;
    font-size: 12px;
    color: #777;
    background: rgba(0, 0, 0, 0.05);
    padding: 5px 10px;
    border-radius: 5px;
}

        /* è¨­å®šè¦–çª— */
        #settingsPopup {
    resize: both; /* âœ… å…è¨±ä½¿ç”¨è€…æ‰‹å‹•èª¿æ•´å¤§å° */
    overflow: auto; /* âœ… ç¢ºä¿å…§å®¹å¯æ»¾å‹• */
    min-width: 300px;
    min-height: 200px;
    max-width: 90vw;
    max-height: 90vh;
    position: fixed;
    background: white;
    padding: 20px;
    border: 1px solid #ccc;
    border-radius: 8px;
    box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);
}

/* âœ… è®“ã€Œè¨­å®šã€è¦–çª—çš„é‚Šæ¡†å¯ä»¥æ­£ç¢ºèª¿æ•´å¤§å°ï¼Œä½†ä¸å½±éŸ¿æ‹–æ›³ */
#settingsPopup:after {
    content: "";
    position: absolute;
    width: 16px;
    height: 16px;
    bottom: 0;
    right: 0;
    cursor: nwse-resize; /* âœ… é¡¯ç¤ºèª¿æ•´å¤§å°çš„æ¸¸æ¨™ */
}

/* âœ… è®“ã€Œè¨­å®šã€è¦–çª—å…§çš„å…§å®¹å€åŸŸå¯æ»¾å‹• */
#settingsContent {
    flex-grow: 1;
    overflow-y: auto;
    padding-bottom: 10px;
}

/* âœ… ç¢ºä¿æ‹–å‹•åŠŸèƒ½åªå½±éŸ¿æ¨™é¡Œæ¬„ï¼Œé˜²æ­¢å½±éŸ¿èª¿æ•´å¤§å° */
#settingsTitleBar {
    width: 100%;
    cursor: grab;
    padding: 5px;
    font-size: 16px;
    background-color: #ddd;
    border-bottom: 1px solid #ccc;
    text-align: center;
    font-weight: bold;
}
/* âœ… è®“è¨­å®šè¦–çª—çš„æ¨™é¡Œæ¬„å›ºå®šåœ¨è¦–çª—çš„æœ€ä¸Šæ–¹ */
#settingsTitleBar {
    position: sticky;
    top: 0;
    width: 100%;
    background: #427f97;
    color: white;
    padding: 10px;
    font-size: 16px;
    font-weight: bold;
    text-align: center;
    cursor: grab;
    border-bottom: 2px solid #ccc;
    z-index: 10; /* âœ… ç¢ºä¿æ¨™é¡Œæ¬„é¡¯ç¤ºåœ¨æœ€ä¸Šå±¤ */
}
        
/* âœ… è®“ã€Œé—œé–‰ã€æŒ‰éˆ•åœ¨ã€Œè¨­å®šè¦–çª—ã€å…§éƒ¨å›ºå®š */
#closeSettingsBtn {
    position: sticky;  /* âœ… è®“å®ƒæ°¸é å›ºå®šåœ¨è¨­å®šè¦–çª—çš„åº•éƒ¨ */
    bottom: 0;
    width: 100%;  /* âœ… è®“æŒ‰éˆ•å¯¬åº¦æ’æ»¿åº•éƒ¨ï¼Œé¿å…è¢«å¿½ç•¥ */
    padding: 10px;
    background-color: #427f97;
    color: white;
    border: none;
    border-radius: 0 0 8px 8px;
    cursor: pointer;
    text-align: center;
    font-size: 16px;
    font-weight: bold;
}

#closeSettingsBtn:hover {
    background-color: #0056b3;
}

/* âœ… å®¹å™¨è¨­è¨ˆï¼Œè®“æ¯”å°çµæœæ˜“è®€ */
.diff-container {
    background: #f9f9f9;
    border: 1px solid #ccc;
    padding: 10px;
    font-size: 16px;
    line-height: 1.6;
    word-break: break-word;
    white-space: pre-wrap;
}

/* âœ… è¨­å®šã€Œæ‰¹é‡ä¸Šå‚³å€åŸŸã€çš„æ¨£å¼ */
fieldset {
    border: 2px solid #ccc;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    background: #f9f9f9;
}

legend {
    font-weight: bold;
    font-size: 16px;
    padding: 5px 10px;
    background: #ddd;
    border-radius: 4px;
}

/* âœ… ç¢ºä¿æ¯”å°çµæœå€å¡Šæ­£å¸¸é¡¯ç¤º */
.diff-container {
    background: #f9f9f9;
    border: 1px solid #ccc;
    padding: 10px;
    font-size: 16px;
    line-height: 1.6;
    word-break: break-word;
    white-space: pre-wrap;  /* âœ… ç¢ºä¿æ›è¡Œæ­£å¸¸ */
    overflow-wrap: break-word;
    min-height: 100px;
    max-height: 300px;
    overflow-y: auto;
}

/* âœ… ç¢ºä¿ OCR æ ¡æ­£é‚è¼¯çš„æ›è¡Œé¡¯ç¤ºæ­£å¸¸ */
#correctionLog {
    white-space: pre-wrap;  /* âœ… ä¿æŒæ›è¡Œ */
    word-wrap: break-word;
    overflow-wrap: break-word;
    font-family: monospace; /* âœ… è®“æ ¼å¼æ›´æ¸…æ™° */
    background: #f9f9f9;
    padding: 10px;
    border: 1px solid #ccc;
    height: 150px;
    width: 90%;
    max-width: 1200px;
}




/* âœ… æ¨™è¨˜åˆªé™¤çš„æ–‡å­— */
.diff-removed {
    background-color: #ffb3b3;
    text-decoration: line-through;
    color: #a00;
    padding: 2px 4px;
    margin: 0 2px;
    border-radius: 3px;
}

/* âœ… æ¨™è¨˜æ–°å¢çš„æ–‡å­— */
.diff-added {
    background-color: #b3ffb3;
    color: #060;
    padding: 2px 4px;
    margin: 0 2px;
    border-radius: 3px;
}



/* âœ… è®“ã€Œè¨­å®šã€è¦–çª—å¯æ»¾å‹•ï¼Œå…§å®¹éé•·æ™‚ä¸å½±éŸ¿ã€Œé—œé–‰ã€æŒ‰éˆ• */
#settingsPopup {
    position: fixed; /* âœ… è®“è¦–çª—å¯ç§»å‹• */
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 600px;
    height: 500px; /* âœ… è¨­å®šæœ€å¤§é«˜åº¦ï¼Œå…§å®¹è¶…éæ™‚å…è¨±æ»¾å‹• */
    min-height: 300px;
    background: white;
    padding: 20px;
    border: 2px solid #ccc;
    border-radius: 8px;
    box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);
    overflow: auto; /* âœ… ç¢ºä¿å…§å®¹å¯ä»¥æ»¾å‹• */
    display: flex;
    flex-direction: column; /* âœ… è®“å…§å®¹å€åŸŸå’ŒæŒ‰éˆ•åˆ†é–‹ */
}

/* âœ… è®“å…§å®¹å€åŸŸå¯ä»¥æ»¾å‹•ï¼Œä½†ã€Œé—œé–‰ã€æŒ‰éˆ•å›ºå®šåœ¨åº•éƒ¨ */
#settingsContent {
    flex-grow: 1;  /* âœ… è®“å…§å®¹å€åŸŸè‡ªé©æ‡‰å¤§å° */
    overflow-y: auto;  /* âœ… å…§å®¹è¶…éæ™‚å…è¨±æ»¾å‹• */
    padding-bottom: 10px;
}
        
        /* æ‰‹å‹•è¨­å®šè¦–çª—å¤§å° */
        #settingsPopup {
            resize: both; /* âœ… å…è¨±æ‰‹å‹•èª¿æ•´å¤§å° */
            overflow: auto; /* âœ… ç¢ºä¿å…§å®¹ä¸æœƒè¢«è£å‰ª */
            min-width: 300px;
            min-height: 200px;
            max-width: 90vw;
            max-height: 90vh;
        }
fieldset {
    border: 2px solid #ccc;  /* âœ… å¤–æ¡†ç·š */
    border-radius: 8px;  /* âœ… åœ“è§’ */
    padding: 15px;
    margin-bottom: 15px;
    background: #f9f9f9;  /* âœ… èƒŒæ™¯è‰² */
}

legend {
    font-weight: bold;
    font-size: 16px;
    padding: 5px 10px;
    background: #ddd;
    border-radius: 4px;
}

/* âœ… æ‰¹æ¬¡ä¸Šå‚³è¦–çª—æ¨£å¼ */
#batchUploadPopup {
    position: fixed; /* âœ… è®“è¦–çª—å¯ç§»å‹• */
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 600px;
    height: 450px;
    background: white;
    padding: 20px;
    border: 2px solid #ccc;
    border-radius: 8px;
    box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);
    overflow: auto;
    display: none; /* é è¨­éš±è— */
    flex-direction: column;
}

/* âœ… æ‰¹æ¬¡ä¸Šå‚³è¦–çª—çš„æ¨™é¡Œæ¬„ */
#batchUploadTitleBar {
    position: sticky;
    top: 0;
    width: 100%;
    background: #427f97;
    color: white;
    padding: 10px;
    font-size: 16px;
    font-weight: bold;
    text-align: center;
    cursor: grab;
    border-bottom: 2px solid #ccc;
    z-index: 10;
}

/* âœ… é—œé–‰æŒ‰éˆ• */
#closeBatchUploadBtn {
    position: sticky;
    bottom: 0;
    width: 100%;
    padding: 10px;
    background-color: #427f97;
    color: white;
    border: none;
    cursor: pointer;
    text-align: center;
    font-size: 16px;
    font-weight: bold;
}
#closeBatchUploadBtn:hover {
    background-color: #0056b3;
}
/* âœ… è®“å…§å®¹å€åŸŸå¯ä»¥æ»¾å‹•ï¼Œä½†ã€Œé—œé–‰ã€æŒ‰éˆ•å›ºå®šåœ¨åº•éƒ¨ */
#BatchUploadContent {
    flex-grow: 1;  /* âœ… è®“å…§å®¹å€åŸŸè‡ªé©æ‡‰å¤§å° */
    overflow-y: auto;  /* âœ… å…§å®¹è¶…éæ™‚å…è¨±æ»¾å‹• */
    padding-bottom: 10px;
}
        
        /* æ‰‹å‹•è¨­å®šè¦–çª—å¤§å° */
        #BatchUploadPopup {
            resize: both; /* âœ… å…è¨±æ‰‹å‹•èª¿æ•´å¤§å° */
            overflow: auto; /* âœ… ç¢ºä¿å…§å®¹ä¸æœƒè¢«è£å‰ª */
            min-width: 300px;
            min-height: 200px;
            max-width: 90vw;
            max-height: 90vh;
        }


    </style>


</head>
<body>
    <!-- âœ… ç¢ºä¿ diff-match-patch.js å…ˆè¼‰å…¥ -->
    <script src="D:/user/æ–‡ä»¶/å·¥ä½œ/OCRæ ¡æ­£å·¥å…·/diff_match_patch.js"></script>

    <h2>IAIAè¨ˆç•«ç”¨ OCR æ ¡æ­£å·¥å…· (ç”± ChatGPT æä¾›æ ¡æ­£)</h2>
    <p class="creator">è£½ä½œè€…ï¼šlightjoy</p>
    
    <button onclick="openSettings()">âš™ï¸ è¨­å®š</button>
    

    <!-- âœ… ä¸‰æ¬„ç‰ˆé¢ -->
    <div class="container">
        <!-- å·¦æ¬„ï¼šè¼¸å…¥ & æ ¡æ­£ -->
        <div class="left-column">
            <h3>è¼¸å…¥ OCR éŒ¯èª¤æ–‡æœ¬</h3>
            <textarea id="ocrInput" placeholder="è«‹è²¼ä¸Š OCR æ–‡å­—..."></textarea>
        <!-- âœ… æ‰¹æ¬¡ä¸Šå‚³æŒ‰éˆ• -->
            <button onclick="openBatchUpload()">ğŸ“‚ æ‰¹æ¬¡ä¸Šå‚³æª”æ¡ˆ</button>

            <h3>æ ¡æ­£å¾Œçš„æ–‡æœ¬</h3>
            <textarea id="correctedOutput" readonly></textarea>
        </div>
    
        <!-- ä¸­é–“æ¬„ï¼šæ¯”å°çµæœ -->
        <div class="middle-column">
            <h3>OCR èˆ‡æ ¡æ­£å¾Œæ–‡æœ¬çš„æ¯”å°çµæœ</h3>
            <div id="diffOutput" class="diff-container" placeholder="é€™è£¡æœƒé¡¯ç¤ºæ ¡æ­£å‰å¾Œçš„å·®åˆ¥è™•"></div>
        </div>
    
        <!-- å³æ¬„ï¼šæ ¡æ­£é‚è¼¯ -->
        <div class="right-column">
            <h3>OCR æ ¡æ­£é‚è¼¯</h3>
            <textarea id="correctionLog" readonly placeholder="é€™è£¡æœƒåˆ—å‡ºé€™æ¬¡ä¿®æ”¹äº†å“ªäº›å­—è©ï¼Œä¸¦è‡ªå‹•æŠŠé€™äº›å­—è©åŠ å…¥å­—å½™å°ç…§åº«ã€‚"></textarea>
        </div>
    </div>
    



<button onclick="correctText()">æ ¡æ­£</button>
<button onclick="compareTexts()">æ¯”å° OCR èˆ‡æ ¡æ­£å¾Œæ–‡æœ¬</button>
<button onclick="downloadCorrectedText()">ä¸‹è¼‰æ ¡æ­£å¾Œæ–‡æœ¬</button>

<!-- è®€å–å‹•ç•« -->
<div id="loading" class="loading">â³ è®€å–ä¸­ï¼Œè«‹ç¨å€™...</div>

<!-- è¨­å®šè¦–çª— -->
    <div id="settingsPopup" class="settings-popup">
        <div id="settingsTitleBar">ğŸ”§ è¨­å®š</div>
        <h3>è¨­å®š</h3>
        <label>OpenAI API Key:</label>
        <input type="text" id="apiKeyInput" placeholder="è¼¸å…¥ä½ çš„ API Key">
        <button onclick="saveApiKey()">ğŸ’¾ å„²å­˜ API Key</button>
    <!-- âœ… ã€Œå­—å½™å°ç…§åº«ã€å€å¡Š -->
    <fieldset>
        <legend>ğŸ“– å­—å½™å°ç…§åº«</legend>
        <p class="description">
            é€™è£¡å¯ä»¥åŠ å…¥å¸¸ç”¨ä¸”ç¢ºå®šçš„ä¿®æ”¹è©å½™å°ç…§ã€‚ChatGPTåªè¦é‡åˆ°é€™äº›éŒ¯èª¤è©ï¼Œéƒ½æœƒå¹«ä½ æ ¡æ­£æˆè¡¨ä¸­çš„è©ã€‚<br>
            å› ç‚ºæ˜¯<b>å¿…å®šæœƒé€²è¡Œä¿®æ­£</b>ï¼Œæ‰€ä»¥è«‹è¦–æƒ…æ³åŠ å…¥ã€‚
            é‡åˆ°ä¸€äº›æ¯”è¼ƒæœ‰å¯èƒ½æ˜¯æ­£ç¢ºçš„è©ï¼ˆåƒæ˜¯æŠŠã€Œå¥³å­ã€è¾¨è­˜æˆã€Œå¤§ä¸ã€ï¼Œä½†ã€Œå¤§ä¸ã€åœ¨æŸäº›æƒ…æ³ä¸‹å¯èƒ½æ˜¯æ­£ç¢ºçš„ï¼‰ï¼Œè«‹åŠ å…¥åº•ä¸‹çš„ã€Œé«˜å„ªå…ˆåƒè€ƒå°ç…§è¡¨ã€ä¸­ï¼Œ<b>å‹¿æ”¾æ–¼æ­¤æ¬„</b>ã€‚<br>
            <b>æ¯æ¬¡æ–‡æœ¬æ ¡æ­£çš„çµæœéƒ½æœƒè‡ªå‹•æ·»åŠ æ–¼é€™å€‹å°ç…§åº«ä¸­ã€‚</b><br>
            âš ï¸ <b>è«‹å®šæœŸå„²å­˜ï¼Œå¦å‰‡ä½ å¯èƒ½å“ªå¤©æœƒæ¬²å“­ç„¡æ·šã€‚</b>
        </p>

        <h4>å­—å½™å°ç…§åº« (JSON æ ¼å¼)</h4>
        <textarea id="errorDictionaryInput" placeholder='{"éŒ¯å­—": "æ­£ç¢ºå­—"}'></textarea>
        
        <h4>æ·»åŠ å°ç…§åº«è©å½™</h4>
        <label>éŒ¯èª¤è©ï¼š</label>
        <input type="text" id="newWrongWord" placeholder="è«‹è¼¸å…¥éŒ¯èª¤è©">
        <label>æ ¡æ­£è©ï¼š</label>
        <input type="text" id="newCorrectWord" placeholder="è«‹è¼¸å…¥æ ¡æ­£å¾Œçš„è©">
        <button onclick="addToDictionary()">æ·»åŠ </button>
        <button onclick="saveErrorDictionary()">ä¿å­˜å­—å½™å°ç…§åº«</button>
        <button onclick="downloadDictionary('errorDictionary', 'å­—å½™å°ç…§åº«')">ä¸‹è¼‰å­—å½™å°ç…§åº«</button>

    <!-- âœ… èªæ–™åº«è¼¸å…¥å€ -->
    <fieldset>
        <legend>ğŸ“– åƒè€ƒèªæ–™åº«</legend>
        <p>è«‹è¼¸å…¥è©²æ™‚ä»£çš„æ–‡ç« ä½œç‚ºåƒè€ƒï¼ŒAI æœƒæ ¹æ“šé€™äº›æ–‡æœ¬é€²è¡Œ OCR æ ¡æ­£ã€‚</p>
        <textarea id="referenceCorpusInput" placeholder="è«‹è¼¸å…¥åƒè€ƒæ–‡ç« ..." style="width: 100%; height: 150px;"></textarea>
        <button onclick="saveReferenceCorpus()">ğŸ’¾ å„²å­˜èªæ–™åº«</button>
        <button onclick="clearReferenceCorpus()">ğŸ—‘ æ¸…ç©ºèªæ–™åº«</button>
    </fieldset>

    </fieldset>



    <!-- âœ… ã€Œé«˜å„ªå…ˆåƒè€ƒå°ç…§è¡¨ã€å€å¡Š -->
    <fieldset>
        <legend>âš ï¸ é«˜å„ªå…ˆåƒè€ƒå°ç…§è¡¨</legend>
        <p class="description">
            é€™è£¡æ”¾çš„ä¸»è¦æ˜¯ä¸Šé¢æ‰€èªªçš„<b>ã€ŒæŠŠã€å¥³å­ã€è¾¨è­˜æˆã€å¤§ä¸ã€ï¼Œä½†ã€å¤§ä¸ã€åœ¨æŸäº›æƒ…æ³ä¸‹å¯èƒ½æ˜¯æ­£ç¢ºçš„ã€</b>è©å½™ã€‚<br>
            ChatGPTåªè¦é‡åˆ°é€™äº›éŒ¯èª¤è©æœƒè€ƒæ…®<b>å„ªå…ˆå°ç…§è‘—ä¿®æ­£ï¼Œä½†ä»æœƒåƒé…Œä¸Šä¸‹æ–‡ï¼Œä¸¦éå¼·åˆ¶ä¿®æ”¹</b>ã€‚
        </p>

        <h4>é«˜å„ªå…ˆåƒè€ƒå°ç…§è¡¨ (JSON æ ¼å¼)</h4>
        <textarea id="highPriorityDictionaryInput" placeholder='{"å¤§ä¸": "å¥³å­", "å°å·´": "å°å…«"}'></textarea>
        
        <h4>æ·»åŠ é«˜å„ªå…ˆå°ç…§è©å½™</h4>
        <label>éŒ¯èª¤è©ï¼š</label>
        <input type="text" id="newHighPriorityWrongWord" placeholder="è«‹è¼¸å…¥éŒ¯èª¤è©">
        <label>æ ¡æ­£è©ï¼š</label>
        <input type="text" id="newHighPriorityCorrectWord" placeholder="è«‹è¼¸å…¥æ ¡æ­£å¾Œçš„è©">
        <button onclick="addToHighPriorityDictionary()">æ·»åŠ </button>
        <button onclick="saveHighPriorityDictionary()">ä¿å­˜é«˜å„ªå…ˆå°ç…§è¡¨</button>
        <button onclick="downloadDictionary('highPriorityDictionary', 'é«˜å„ªå…ˆåƒè€ƒå°ç…§è¡¨')">ä¸‹è¼‰é«˜å„ªå…ˆåƒè€ƒå°ç…§è¡¨</button>

    </fieldset>

<!-- âœ… é—œé–‰æŒ‰éˆ•ä»ç„¶åœ¨å³ä¸‹è§’ -->
<button id="closeSettingsBtn" onclick="closeSettings()">é—œé–‰</button>    
</div>

<!-- âœ… æ‰¹æ¬¡ä¸Šå‚³è¦–çª— -->
<div id="batchUploadPopup" class="popup">
    <div id="batchUploadTitleBar">ğŸ“‚ æ‰¹æ¬¡ä¸Šå‚³</div>
    <!-- ä¸Šå‚³æª”æ¡ˆå€åŸŸ -->
    <input type="file" id="batchFileInput" multiple accept=".txt">
    <!-- æª”æ¡ˆåˆ—è¡¨ï¼ˆå¯æ’åºï¼‰ -->
    <h4>å·²é¸æ“‡çš„æª”æ¡ˆ</h4>
    <ul id="batchFileList"></ul>

    <!-- åˆä½µ & é è¦½ -->
    <h4>åˆä½µå¾Œçš„ OCR é è¦½</h4>
    <textarea id="batchMergedPreview" readonly placeholder="é€™è£¡æœƒé¡¯ç¤ºåˆä½µå¾Œçš„ OCR å…§å®¹"></textarea>
    <button onclick="mergeBatchFiles()">ğŸ”„ åˆä½µæª”æ¡ˆ</button>
    <button onclick="loadMergedToOCR()">ğŸ“¤ è¼‰å…¥åˆ° OCR å€åŸŸ</button>

    <!-- âœ… ç¢ºä¿ã€Œé—œé–‰æŒ‰éˆ•ã€ä¸å½±éŸ¿ã€Œè¨­å®šã€è¦–çª— -->
    <button id="closeBatchUploadBtn" onclick="closeBatchUpload()">é—œé–‰</button>
</div>


<script>

console.log("ğŸ” æª¢æŸ¥ batchFileInput:", document.getElementById("batchFileInput"));
let correctionLogChunks = [];  // âœ… è¨­å®šç‚ºå…¨åŸŸè®Šæ•¸ï¼Œç¢ºä¿å¤šæ¬¡æ ¡æ­£æ™‚ä¸æœƒéºå¤±æ•¸æ“š

// âœ… é–‹å•Ÿè¨­å®šè¦–çª—
function openSettings() {
    document.getElementById("settingsPopup").style.display = "block";
    let savedApiKey = localStorage.getItem("apiKey");
    let savedReferenceCorpus = localStorage.getItem("referenceCorpus") || ""; // âœ… é¿å… undefined

    document.getElementById("apiKeyInput").value = savedApiKey || "";
    document.getElementById("referenceCorpusInput").value = savedReferenceCorpus;
}


// âœ… é—œé–‰è¨­å®šè¦–çª—
function closeSettings() {
    document.getElementById("settingsPopup").style.display = "none";
}

// âœ… å„²å­˜ API Key & å­—å½™å°ç…§åº«
function saveSettings() {
    let apiKey = document.getElementById("apiKeyInput").value;
    let errorDictionaryInput = document.getElementById("errorDictionaryInput").value;

    if (apiKey) {
        localStorage.setItem("apiKey", apiKey);
    }

    if (referenceCorpus) {
        localStorage.setItem("referenceCorpus", referenceCorpus); // âœ… ç¢ºä¿èªæ–™åº«è¢«å„²å­˜
    }

    alert("âœ… è¨­å®šå·²æˆåŠŸå„²å­˜ï¼");

    try {
        let errorDictionary = JSON.parse(errorDictionaryInput); // ç¢ºä¿ JSON æ ¼å¼æ­£ç¢º
        let formattedJson = JSON.stringify(errorDictionary, null, 2);

        localStorage.setItem("apiKey", apiKey);
        localStorage.setItem("errorDictionary", formattedJson);
        document.getElementById("errorDictionaryInput").value = formattedJson;

        alert("è¨­å®šå·²ä¿å­˜ï¼");
        closeSettings();
    } catch (error) {
        alert("å­—å½™å°ç…§åº«æ ¼å¼éŒ¯èª¤ï¼Œè«‹ç¢ºèª JSON æ˜¯å¦æ­£ç¢ºï¼");
    }
    
}

// âœ… æ·»åŠ å°ç…§åº«è©å½™
function addToDictionary() {
    let wrongWord = document.getElementById("newWrongWord").value.trim();
    let correctWord = document.getElementById("newCorrectWord").value.trim();

    if (!wrongWord || !correctWord) {
        alert("è«‹è¼¸å…¥éŒ¯èª¤è©å’Œæ ¡æ­£è©ï¼");
        return;
    }

    let errorDict = JSON.parse(localStorage.getItem("errorDictionary") || "{}");

    if (errorDict[wrongWord]) {
        alert("é€™å€‹éŒ¯èª¤è©å·²ç¶“å­˜åœ¨æ–¼å°ç…§åº«ä¸­ï¼");
        return;
    }

    errorDict[wrongWord] = correctWord; // âœ… æ·»åŠ æ–°å°ç…§è©çµ„
    localStorage.setItem("errorDictionary", JSON.stringify(errorDict, null, 2));

    // âœ… æ›´æ–°é¡¯ç¤º
    document.getElementById("errorDictionaryInput").value = JSON.stringify(errorDict, null, 2);
    document.getElementById("newWrongWord").value = "";
    document.getElementById("newCorrectWord").value = "";

    alert("è©å½™å·²æˆåŠŸæ·»åŠ åˆ°å°ç…§åº«ï¼");
}

// âœ… æ·»åŠ ã€Œé«˜å„ªå…ˆåƒè€ƒå°ç…§è¡¨ã€è©å½™
function addToHighPriorityDictionary() {
    let wrongWord = document.getElementById("newHighPriorityWrongWord").value.trim();
    let correctWord = document.getElementById("newHighPriorityCorrectWord").value.trim();

    if (!wrongWord || !correctWord) {
        alert("è«‹è¼¸å…¥éŒ¯èª¤è©å’Œæ ¡æ­£è©ï¼");
        return;
    }

    let highPriorityDictionary = JSON.parse(localStorage.getItem("highPriorityDictionary") || "{}");

    if (highPriorityDictionary[wrongWord]) {
        alert("é€™å€‹éŒ¯èª¤è©å·²ç¶“å­˜åœ¨æ–¼é«˜å„ªå…ˆåƒè€ƒå°ç…§è¡¨ä¸­ï¼");
        return;
    }

    highPriorityDictionary[wrongWord] = correctWord; // âœ… æ·»åŠ æ–°å°ç…§è©çµ„
    localStorage.setItem("highPriorityDictionary", JSON.stringify(highPriorityDictionary, null, 2));

    // âœ… æ›´æ–°é¡¯ç¤º
    document.getElementById("highPriorityDictionaryInput").value = JSON.stringify(highPriorityDictionary, null, 2);
    document.getElementById("newHighPriorityWrongWord").value = "";
    document.getElementById("newHighPriorityCorrectWord").value = "";

    alert("è©å½™å·²æˆåŠŸæ·»åŠ åˆ°é«˜å„ªå…ˆåƒè€ƒå°ç…§è¡¨ï¼");
}

// âœ… å„²å­˜ã€Œé«˜å„ªå…ˆåƒè€ƒå°ç…§è¡¨ã€
function saveHighPriorityDictionary() {
    let highPriorityDictionaryInput = document.getElementById("highPriorityDictionaryInput").value;

    try {
        let highPriorityDictionary = JSON.parse(highPriorityDictionaryInput); // ç¢ºä¿ JSON æ ¼å¼æ­£ç¢º
        localStorage.setItem("highPriorityDictionary", JSON.stringify(highPriorityDictionary, null, 2));
        document.getElementById("highPriorityDictionaryInput").value = JSON.stringify(highPriorityDictionary, null, 2);

        alert("é«˜å„ªå…ˆåƒè€ƒå°ç…§è¡¨å·²ä¿å­˜ï¼");
    } catch (error) {
        alert("æ ¼å¼éŒ¯èª¤ï¼Œè«‹è¼¸å…¥æ­£ç¢ºçš„ JSON ç‰©ä»¶æ ¼å¼ï¼Œä¾‹å¦‚ï¼š{\"å¤§ä¸\": \"å¥³å­\", \"å°å·´\": \"å°å…«\"}");
    }
}

// âœ… åœ¨é–‹å•Ÿã€Œè¨­å®šã€è¦–çª—æ™‚ï¼Œè‡ªå‹•è¼‰å…¥ `localStorage` å…§çš„å°ç…§åº«è³‡æ–™
function loadDictionaries() {
    let errorDictionary = localStorage.getItem("errorDictionary") || "{}";
    let highPriorityDictionary = localStorage.getItem("highPriorityDictionary") || "{}";

    // âœ… é¡¯ç¤ºåœ¨ textarea å…§ï¼Œç¢ºä¿å³ä½¿é‡æ–°æ•´ç†é é¢ï¼Œå…§å®¹ä»ç„¶ä¿ç•™
    document.getElementById("errorDictionaryInput").value = JSON.stringify(JSON.parse(errorDictionary), null, 2);
    document.getElementById("highPriorityDictionaryInput").value = JSON.stringify(JSON.parse(highPriorityDictionary), null, 2);
}

// âœ… åœ¨é é¢è¼‰å…¥æ™‚ï¼Œè‡ªå‹•è¼‰å…¥è³‡æ–™
window.onload = loadDictionaries;

// âœ… é€šç”¨å‡½å¼ï¼šä¸‹è¼‰ JSON è¨­å®šæª”
function downloadDictionary(storageKey, fileName) {
    let data = localStorage.getItem(storageKey);

    if (!data || data === "{}") {
        alert(fileName + " ç‚ºç©ºï¼Œç„¡æ³•ä¸‹è¼‰ï¼");
        return;
    }

    try {
        let blob = new Blob([data], { type: "application/json" });
        let link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = fileName + ".json";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    } catch (error) {
        alert(fileName + " ä¸‹è¼‰å¤±æ•—ï¼");
    }
}


// âœ… åŒ¯å‡º JSON å°ç…§åº«
function exportDictionary() {
    let dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(localStorage.getItem("errorDictionary"));
    let downloadAnchor = document.createElement("a");
    downloadAnchor.setAttribute("href", dataStr);
    downloadAnchor.setAttribute("download", "error_dictionary.json");
    document.body.appendChild(downloadAnchor);
    downloadAnchor.click();
    document.body.removeChild(downloadAnchor);
}

// âœ… è®“è¨­å®šè¦–çª—å¯æ‹–å‹•
function makeSettingsDraggable() {
    let popup = document.getElementById("settingsPopup");
    let titleBar = document.getElementById("settingsTitleBar"); // âœ… è®“æ¨™é¡Œæ¬„æˆç‚ºæ‹–å‹•å€åŸŸ
    let offsetX = 0, offsetY = 0, isDragging = false;

    titleBar.addEventListener("mousedown", function(e) {
        isDragging = true;
        offsetX = e.clientX - popup.offsetLeft;
        offsetY = e.clientY - popup.offsetTop;
        titleBar.style.cursor = "grabbing"; // æ”¹è®Šæ¸¸æ¨™æ¨£å¼
    });

    document.addEventListener("mousemove", function(e) {
        if (isDragging) {
            popup.style.left = (e.clientX - offsetX) + "px";
            popup.style.top = (e.clientY - offsetY) + "px";
        }
    });

    document.addEventListener("mouseup", function() {
        isDragging = false;
        titleBar.style.cursor = "grab"; // æ¢å¾©æ¸¸æ¨™æ¨£å¼
    });
}
    makeSettingsDraggable(); // âœ… å•Ÿå‹•æ‹–å‹•åŠŸèƒ½

// âœ… è§£æç´”æ–‡å­—æ ¼å¼ï¼Œä»ç„¶èƒ½è‡ªå‹•æ›´æ–°å­—å½™å°ç…§åº«
function updateErrorDictionary(correctionLogText) {
    let errorDict = JSON.parse(localStorage.getItem("errorDictionary") || "{}");

    let newEntries = correctionLogText.split("\n"); // âœ… é€è¡Œè§£æéŒ¯èª¤å°æ‡‰é—œä¿‚
    newEntries.forEach(entry => {
        let match = entry.match(/^(.+?)\s*->\s*(.+)$/);
        if (match) {
            let wrong = match[1].trim();
            let correct = match[2].trim();
            if (wrong && correct && !errorDict[wrong]) {
                errorDict[wrong] = correct; // âœ… åªåŠ å…¥æ–°çš„éŒ¯èª¤å°æ‡‰
            }
        }
    });

    localStorage.setItem("errorDictionary", JSON.stringify(errorDict, null, 2));
    document.getElementById("errorDictionaryInput").value = JSON.stringify(errorDict, null, 2); // âœ… æ›´æ–°é¡¯ç¤º
}

// âœ… åœ¨ OCR æ ¡æ­£å®Œæˆå¾Œï¼Œè‡ªå‹•æ›´æ–°å°ç…§åº«
if (correctionLogChunks.length > 0) {
    updateErrorDictionary(correctionLogChunks.join("\n"));
} else {
    console.warn("âš ï¸ correctionLogChunks ç‚ºç©ºï¼Œç„¡æ³•æ›´æ–°å°ç…§åº«ï¼");
}

function saveApiKey() {
    let apiKey = document.getElementById("apiKeyInput").value.trim();

    if (!apiKey.startsWith("sk-")) {
        alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„ OpenAI API Keyï¼");
        return;
    }

    localStorage.setItem("apiKey", apiKey);
    alert("âœ… API Key å·²æˆåŠŸå„²å­˜ï¼");
}


// âœ… ä½¿ç”¨ diff-match-patch ä¾†æ¯”å° OCR åŸæ–‡ & æ ¡æ­£å¾Œæ–‡æœ¬
function compareTexts() {
    if (typeof diff_match_patch === "undefined") {
        alert("âŒ éŒ¯èª¤ï¼šdiff-match-patch.js æ²’æœ‰è¼‰å…¥ï¼Œè«‹ç¨å€™å†è©¦ï¼");
        return;
    }

    let ocrText = document.getElementById("ocrInput").value.trim();
    let correctedText = document.getElementById("correctedOutput").value.trim();
    let diffOutput = document.getElementById("diffOutput");

    if (!ocrText || !correctedText) {
        alert("è«‹è¼¸å…¥ OCR åŸæ–‡èˆ‡æ ¡æ­£å¾Œçš„æ–‡æœ¬ï¼");
        return;
    }

    // âœ… å‰µå»º Diff-Match-Patch ç‰©ä»¶
    let dmp = new diff_match_patch();
    let diffs = dmp.diff_main(ocrText, correctedText);

    console.log("Diff çµæœï¼š", diffs);  // âœ… æª¢æŸ¥ Diff çµæœæ˜¯å¦æ­£ç¢º

    if (!diffs || diffs.length === 0) {
        alert("æ¯”å°çµæœç‚ºç©ºï¼");
        return;
    }

    // âœ… è®“ Diff çµæœæ›´æº–ç¢º
    dmp.diff_cleanupSemantic(diffs);

    let diffHtml = diffs.map(part => {
        let text = part[1].replace(/\n/g, "<br>");  // âœ… ç¢ºä¿æ›è¡Œæ­£ç¢ºé¡¯ç¤º
        if (part[0] === 1) {
            return `<span class="diff-added">${text}</span>`;
        } else if (part[0] === -1) {
            return `<span class="diff-removed">${text}</span>`;
        } else {
            return `<span>${text}</span>`;
        }
    }).join("");

    diffOutput.innerHTML = diffHtml;
}



// âœ… æ‰‹å‹•è¼‰å…¥ diff-match-patch.js
function loadDiffMatchPatch() {
    let script = document.createElement("script");
    script.src = "D:/user/æ–‡ä»¶/å·¥ä½œ/OCRæ ¡æ­£å·¥å…·/diff_match_patch.js";
    script.onload = function() {
        console.log("âœ… diff-match-patch.js å·²æˆåŠŸè¼‰å…¥");
    };
    script.onerror = function() {
        console.error("âŒ ç„¡æ³•è¼‰å…¥ diff-match-patch.js");
    };
    document.head.appendChild(script);
}


// âœ… ç¢ºä¿æ‰¹æ¬¡ä¸Šå‚³è¦–çª—èƒ½å¤ æ‰“é–‹
function openBatchUpload() {
    let popup = document.getElementById("batchUploadPopup");
    if (popup) {
        popup.style.display = "block";
    } else {
        console.error("âŒ æ‰¾ä¸åˆ° batchUploadPopup å…ƒç´ ï¼");
    }
}

// âœ… ç¢ºä¿æ‰¹æ¬¡ä¸Šå‚³è¦–çª—å¯ä»¥é—œé–‰
function closeBatchUpload() {
    let popup = document.getElementById("batchUploadPopup");
    if (popup) {
        popup.style.display = "none";
    }
}


// âœ… è®“æ‰¹æ¬¡ä¸Šå‚³è¦–çª—å¯æ‹–å‹•
function makeBatchUploadDraggable() {
    let popup = document.getElementById("batchUploadPopup");
    let titleBar = document.getElementById("batchUploadTitleBar");
    let offsetX = 0, offsetY = 0, isDragging = false;

    titleBar.addEventListener("mousedown", function(e) {
        isDragging = true;
        offsetX = e.clientX - popup.offsetLeft;
        offsetY = e.clientY - popup.offsetTop;
        titleBar.style.cursor = "grabbing";
    });

    document.addEventListener("mousemove", function(e) {
        if (isDragging) {
            popup.style.left = (e.clientX - offsetX) + "px";
            popup.style.top = (e.clientY - offsetY) + "px";
        }
    });

    document.addEventListener("mouseup", function() {
        isDragging = false;
        titleBar.style.cursor = "grab";
    });
}
makeBatchUploadDraggable(); // âœ… å•Ÿå‹•æ‹–å‹•åŠŸèƒ½



// âœ… ä¸Šå‚³ & é¡¯ç¤ºæª”æ¡ˆ
let batchUploadedFiles = [];

document.addEventListener("DOMContentLoaded", function () {
    let batchInput = document.getElementById("batchFileInput");

    console.log("ğŸ” æª¢æŸ¥ batchFileInput:", batchInput);

    if (batchInput) {
        try {
            batchInput.addEventListener("change", handleBatchUpload);
            console.log("ğŸ“‚ batchFileInput äº‹ä»¶ç›£è½å·²ç¶å®šï¼");
        } catch (error) {
            console.error("âŒ éŒ¯èª¤ï¼šç¶å®šäº‹ä»¶ç›£è½å¤±æ•—ï¼", error);
        }
    } else {
        console.error("âŒ éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° batchFileInputï¼Œè«‹æª¢æŸ¥ HTML çš„ id æ˜¯å¦æ­£ç¢ºï¼");
    }
});
console.log("ğŸ“‚ batchFileInput äº‹ä»¶ç›£è½å·²ç¶å®šï¼");

function handleBatchUpload() {
    console.log("ğŸ“‚ handleBatchUpload() è¢«åŸ·è¡Œï¼"); // âœ… æ¸¬è©¦æ˜¯å¦æœ‰é€²å…¥å‡½å¼

    let input = document.getElementById("batchFileInput");
    
    if (!input.files.length) {
        alert("è«‹é¸æ“‡è‡³å°‘ä¸€å€‹æª”æ¡ˆï¼");
        return;
    }

    batchUploadedFiles = Array.from(input.files);
    console.log("âœ… å·²é¸æ“‡æª”æ¡ˆï¼š", batchUploadedFiles); // âœ… æ¸¬è©¦æ˜¯å¦æœ‰æŠ“åˆ°æª”æ¡ˆ
    displayBatchFileList();
}

// âœ… é¡¯ç¤ºå·²é¸æ“‡çš„æª”æ¡ˆ
function displayBatchFileList() {
    console.log("ğŸ“‚ é¡¯ç¤ºæª”æ¡ˆåˆ—è¡¨...", batchUploadedFiles); // âœ… æª¢æŸ¥é€™è¡Œæ˜¯å¦æœ‰åŸ·è¡Œ
    let fileList = document.getElementById("batchFileList");

    fileList.innerHTML = ""; // æ¸…ç©ºèˆŠåˆ—è¡¨

    batchUploadedFiles.forEach((file, index) => {
        let li = document.createElement("li");
        li.textContent = file.name;

        let upButton = document.createElement("button");
        upButton.textContent = "â–²";
        upButton.onclick = () => moveBatchFile(index, -1);

        let downButton = document.createElement("button");
        downButton.textContent = "â–¼";
        downButton.onclick = () => moveBatchFile(index, 1);

        li.appendChild(upButton);
        li.appendChild(downButton);
        fileList.appendChild(li);
    });
}


// âœ… ç§»å‹•æª”æ¡ˆé †åº
function moveBatchFile(index, direction) {
    let newIndex = index + direction;
    if (newIndex >= 0 && newIndex < batchUploadedFiles.length) {
        [batchUploadedFiles[index], batchUploadedFiles[newIndex]] = [batchUploadedFiles[newIndex], batchUploadedFiles[index]];
        displayBatchFileList();
    }
}

// âœ… åˆä½µæª”æ¡ˆå…§å®¹ä¸¦é è¦½
async function mergeBatchFiles() {
    if (batchUploadedFiles.length === 0) {
        alert("è«‹å…ˆé¸æ“‡æª”æ¡ˆï¼");
        return;
    }

    console.log("ğŸ”„ é–‹å§‹åˆä½µæª”æ¡ˆ...", batchUploadedFiles); // âœ… ç¢ºä¿æª”æ¡ˆå­˜åœ¨

    let mergedText = "";
    for (let file of batchUploadedFiles) {
        let text = await file.text();
        mergedText += text.trim() + "\n\n";
    }

    document.getElementById("batchMergedPreview").value = mergedText;
    console.log("âœ… åˆä½µå®Œæˆï¼", mergedText); // âœ… ç¢ºä¿å…§å®¹æ­£ç¢º
    alert("æª”æ¡ˆåˆä½µæˆåŠŸï¼");
}



// âœ… è¼‰å…¥åˆä½µå…§å®¹åˆ° OCR å€åŸŸ
function loadMergedToOCR() {
    let mergedText = document.getElementById("batchMergedPreview").value;
    if (mergedText.trim().length === 0) {
        alert("ç„¡åˆä½µå…§å®¹å¯è¼‰å…¥ï¼");
        return;
    }
    document.getElementById("ocrInput").value = mergedText;
    alert("å·²è¼‰å…¥åˆä½µå…§å®¹åˆ° OCR å€åŸŸï¼");
}


// âœ… ç¢ºä¿ DOM è¼‰å…¥å¾Œæ‰åŸ·è¡Œï¼Œé¿å…æ‰¾ä¸åˆ°å…ƒç´ 
document.addEventListener("DOMContentLoaded", function () {
    let fileInput = document.getElementById("batchFileInput");
    if (fileInput) {
        fileInput.addEventListener("change", handleBatchUpload);
        console.log("âœ… æ‰¹æ¬¡ä¸Šå‚³æª”æ¡ˆæŒ‰éˆ•ç¶å®šæˆåŠŸï¼");
    } else {
        console.error("âŒ ç„¡æ³•æ‰¾åˆ° batchFileInputï¼Œè«‹æª¢æŸ¥ HTML æ˜¯å¦æ­£ç¢ºï¼");
    }
});

// âœ… å„²å­˜èªæ–™åº«åˆ° localStorage
function saveReferenceCorpus() {
    let referenceCorpus = document.getElementById("referenceCorpusInput").value.trim();
    localStorage.setItem("referenceCorpus", referenceCorpus);
    alert("ğŸ“– èªæ–™åº«å·²æˆåŠŸä¿å­˜ï¼");
}

// âœ… æ¸…ç©ºèªæ–™åº«
function clearReferenceCorpus() {
    localStorage.removeItem("referenceCorpus");
    document.getElementById("referenceCorpusInput").value = "";
    alert("ğŸ“– èªæ–™åº«å·²æ¸…ç©ºï¼");
}

// âœ… è¼‰å…¥èªæ–™åº«ï¼ˆç•¶ä½¿ç”¨è€…æ‰“é–‹è¨­å®šæ™‚è‡ªå‹•è¼‰å…¥ï¼‰
function loadReferenceCorpus() {
    document.getElementById("referenceCorpusInput").value = localStorage.getItem("referenceCorpus") || "";
}

// âœ… ç•¶é é¢è¼‰å…¥æ™‚ï¼Œè‡ªå‹•è¼‰å…¥èªæ–™åº«
window.onload = function () {
    loadReferenceCorpus();
};


// âœ… **å°‡ correctionLogChunks è¨­ç‚ºå…¨åŸŸè®Šæ•¸**
window.correctionLogChunks = []; 

// âœ… **OCR æ ¡æ­£åŠŸèƒ½ï¼ˆæ”¯æ´æ‰¹é‡ & è¶…é•·æ–‡æœ¬ï¼‰**
async function correctText() {
    let correctedChunks = [];
    let referenceCorpus = localStorage.getItem("referenceCorpus") || ""; // âœ… ç¢ºä¿è®Šæ•¸ä¸æœƒæ˜¯ undefined

    
    let ocrText = document.getElementById("ocrInput").value;
    let apiKey = localStorage.getItem("apiKey");

    if (!apiKey || !apiKey.startsWith("sk-")) {
        alert("è«‹æä¾›æœ‰æ•ˆçš„ OpenAI API Keyï¼");
        return;
    }

    let errorDictionary = JSON.parse(localStorage.getItem("errorDictionary") || "{}");
    let highPriorityDictionary = JSON.parse(localStorage.getItem("highPriorityDictionary") || "{}");

    let errorEntries = Object.entries(errorDictionary)
        .map(([wrong, correct]) => `${wrong} -> ${correct}`)
        .join("\n");

    let highPriorityEntries = Object.entries(highPriorityDictionary)
        .map(([wrong, correct]) => `${wrong} -> ${correct}`)
        .join("\n");

    let prompt = `ä½ å¥½ã€‚ä»¥ä¸‹é€™æ®µæ–‡å­—æ˜¯ä¸€ä»½æ°‘åœ‹åˆå¹´çš„é›œèªŒï¼Œé€²è¡Œ OCR çš„çµæœã€‚å…¶ä¸­æœ‰è¨±å¤šè¾¨è­˜éŒ¯èª¤çš„å­—å’Œæ¨™é»ç¬¦è™Ÿã€‚
    é€™æ˜¯ä¸€ä»½ OCR éŒ¯èª¤ä¿®æ­£ä»»å‹™ã€‚è«‹å„ªå…ˆè€ƒæ…®ã€Œå­—å‹ç›¸ä¼¼çš„éŒ¯èª¤ã€ï¼Œé‡åˆ°é¡ä¼¼çš„éŒ¯èª¤æ™‚ï¼Œè«‹å„ªå…ˆåƒè€ƒç­†ç•«ç›¸ä¼¼çš„æ­£ç¢ºå­—ï¼Œè€Œéèªç¾©ç›¸è¿‘çš„è©ã€‚
    ä½ çš„ä»»å‹™æ˜¯ **åªä¿®æ­£ OCR è¾¨è­˜éŒ¯èª¤çš„å­—**ï¼Œè«‹ **çµ•å°ä¸è¦æ“…è‡ªå¢åŠ æˆ–æ¸›å°‘ä»»ä½•å­—è©**ï¼Œè«‹ **é€å­—å°æ‡‰ä¿®æ­£**ã€‚

    **âœ… å…è¨±**ï¼šæ›´æ­£ OCR éŒ¯èª¤çš„å­—ï¼Œä¾‹å¦‚ã€Œçº‡ -> é¡ã€ã€‚
    **âŒ ç¦æ­¢**ï¼š
    1. **ä¸è¦æ“…è‡ªå¢åˆªå­—**ã€‚
    2. **ä¸è¦æ›´å‹•èªåº**ï¼Œå¦‚æœå¥å­ä¸é€šé †ï¼Œè«‹ä»ç„¶ç¶­æŒåŸæ¨£ã€‚
    3. **ä¸è¦é‡æ–°çµ„ç¹”å¥å­**ï¼Œåªèƒ½é€²è¡ŒéŒ¯å­—æ ¡æ­£ã€‚
    4. **åƒè€ƒä¸‹æ–¹æä¾›çš„æ–‡ç« **ï¼Œç¢ºä¿ç”¨è©ã€å¥æ³•ç¬¦åˆè©²æ™‚ä»£ç¿’æ…£ã€‚

    ---

    ğŸ”¹ **ğŸ“– åƒè€ƒèªæ–™ï¼ˆè©²æ™‚ä»£æ–‡ç« ï¼‰ï¼š**
    ${referenceCorpus}

    ---


    å¦‚æœ OCR åŸæ–‡å…§æ²’æœ‰éŒ¯å­—ï¼Œè«‹è¼¸å‡ºã€Œç„¡é ˆæ ¡æ­£ã€ã€‚

    **éŒ¯èª¤å°ç…§åº«**ï¼š
    \n\n${errorEntries}

    **âš ï¸ é«˜å„ªå…ˆåƒè€ƒå°ç…§è¡¨**ï¼š
    \n\n${highPriorityEntries}

    **è«‹ä¾ç…§é€™äº›è¦å‰‡é€²è¡Œä¿®æ­£ï¼Œç¢ºä¿æ–‡æœ¬æ¢å¾©ç‚ºæ­£ç¢ºçš„ç¹é«”ä¸­æ–‡ã€‚**`;

    let loadingIndicator = document.getElementById("loading");
    let correctedOutput = document.getElementById("correctedOutput");
    let correctionLog = document.getElementById("correctionLog");

    loadingIndicator.style.display = "block";

    const MAX_CHUNK_SIZE = 1000;
    let textChunks = splitText(ocrText, MAX_CHUNK_SIZE);

    // âœ… **æ¸…ç©ºèˆŠçš„ correctionLogChunksï¼Œç¢ºä¿é€™æ¬¡æ ¡æ­£æ˜¯æ–°çš„**
    window.correctionLogChunks = [];

    for (let chunk of textChunks) {
        try {
            let response = await fetch("https://api.openai.com/v1/chat/completions", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + apiKey
                },
                body: JSON.stringify({
                    model: "gpt-4-turbo",
                    messages: [
                        { "role": "system", "content": prompt },
                        { "role": "user", "content": `è«‹å¹«æˆ‘æ ¡æ­£ä»¥ä¸‹ OCR æ–‡å­—éŒ¯èª¤ï¼š\n\n${chunk}` },
                        { "role": "user", "content": `æ­¤å¤–ï¼Œè«‹æä¾› OCR æ ¡æ­£é‚è¼¯ï¼š\n\n---\næ ¡æ­£å¾Œçš„æ–‡æœ¬ï¼š\n[æ ¡æ­£å¾Œçš„å…§å®¹]\n\nOCR æ ¡æ­£é‚è¼¯ï¼š\n[éŒ¯èª¤å­—è© -> ä¿®æ­£å¾Œçš„å…§å®¹]\n---` }
                    ]
                })
            });

            // âœ… **ç¢ºä¿ `data` æ˜¯æ­£ç¢ºçš„ JSONï¼Œé¿å… `undefined` éŒ¯èª¤**
            let data = await response.json() || { choices: [{ message: { content: "ç„¡æ³•ç²å–æ ¡æ­£çµæœ" } }] };
            console.log("ğŸ” GPT å›æ‡‰ï¼š", data); // **åµéŒ¯ç”¨**

            let responseText = data.choices[0].message.content || "ç„¡æ³•ç²å–æ ¡æ­£çµæœ";

            let correctedText = responseText.split("\n\nOCR æ ¡æ­£é‚è¼¯ï¼š")[0].replace("æ ¡æ­£å¾Œçš„æ–‡æœ¬ï¼š", "").trim();
            let correctionLogicMatch = responseText.match(/OCR æ ¡æ­£é‚è¼¯ï¼š\n([\s\S]+)/);
            let correctionLogic = correctionLogicMatch ? correctionLogicMatch[1].trim() : "ç„¡æ³•æä¾›æ ¡æ­£é‚è¼¯";

            console.log("ğŸ” æå–çš„ correctionLogic:", correctionLogic);

            correctedChunks.push(correctedText);
            window.correctionLogChunks.push(correctionLogic);

        } catch (error) {
            console.error("éŒ¯èª¤ï¼š", error);
            alert("è«‹æ±‚å¤±æ•—ï¼Œè«‹æª¢æŸ¥ API Key æˆ–ç¶²è·¯é€£ç·šï¼");
            correctedChunks.push("âš ï¸ æ ¡æ­£å¤±æ•—");
            window.correctionLogChunks.push("âš ï¸ ç„¡æ³•æä¾›æ ¡æ­£é‚è¼¯");
        }
    }

    loadingIndicator.style.display = "none";
    correctedOutput.value = correctedChunks.join("\n\n");
    correctionLog.value = window.correctionLogChunks.join("\n\n");

    console.log("ğŸš€ correctionLogChunks æ›´æ–°å¾Œï¼š", window.correctionLogChunks);

    // âœ… **æ ¡æ­£å®Œæˆå¾Œï¼Œè‡ªå‹•æ›´æ–°å­—å½™å°ç…§åº«**
    updateErrorDictionary(window.correctionLogChunks.join("\n"));
}


// âœ… åˆ‡åˆ†æ–‡æœ¬æˆå¤šå€‹å€å¡Š
function splitText(text, maxSize) {
    let chunks = [];
    for (let i = 0; i < text.length; i += maxSize) {
        chunks.push(text.substring(i, i + maxSize));
    }
    return chunks;
}

// âœ… è§£æå›æ‡‰ï¼Œç¢ºä¿ä¸æœƒåˆªæ¸›æ–‡æœ¬
let responseText = data.choices[0].message.content;

// ç¢ºä¿æ–‡æœ¬è§£æä¸æœƒå‡ºéŒ¯
let correctedTextMatch = responseText.match(/æ ¡æ­£å¾Œçš„æ–‡æœ¬ï¼š\n([\s\S]+?)\n\nOCR æ ¡æ­£é‚è¼¯ï¼š/);
let correctionLogicMatch = responseText.match(/OCR æ ¡æ­£é‚è¼¯ï¼š\n([\s\S]+)/);

let correctedText = correctedTextMatch ? correctedTextMatch[1].trim() : ocrText; // âœ… é˜²æ­¢å›å‚³ç©ºå€¼
let correctionLogic = correctionLogicMatch ? correctionLogicMatch[1].trim() : "ç„¡æ³•æä¾›æ ¡æ­£é‚è¼¯";


// âœ… é¿å… GPT éŒ¯èª¤å›æ‡‰ã€Œç„¡é ˆæ ¡æ­£ã€
if (correctedText.includes("ç„¡é ˆæ ¡æ­£") && correctedText.length < 20) {
    correctedText = ocrText; // âœ… ä¿ç•™åŸå§‹æ–‡æœ¬
}


correctedChunks.push(correctedText);
correctionLogChunks.push(correctionLogic);

// âœ… ä¸‹è¼‰æ ¡æ­£å¾Œçš„æ–‡æœ¬
function downloadCorrectedText() {
    let correctedText = document.getElementById("correctedOutput").value;
    
    if (!correctedText) {
        alert("æ²’æœ‰æ ¡æ­£å¾Œçš„æ–‡æœ¬å¯ä¸‹è¼‰ï¼");
        return;
    }

    let blob = new Blob([correctedText], { type: "text/plain" });
    let link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "æ ¡æ­£å¾Œæ–‡æœ¬.txt";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

    </script>
 <div id="versionNumber">ç‰ˆæœ¬ï¼š1.0.5</div>   
</body>
</html>
